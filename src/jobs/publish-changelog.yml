description: |2
  Commit changes to the changelog and merge into a remote branch using the process:

  1. Configure Git to allow a commit.
  2. Making a new branch.
  3. Detect and commit the changes to the CHANGELOG, if none, then exit.
  4. Pushing the branch back to remote GitHub.
  5. Use the GitHub CLI to make a PR.
  6. Then immediately merge the changes in the desired branch.

  We use a PR instead of a push in case the branch is protected from direct pushes.
parameters:
  branch:
    description: Name of the branch to merge into.
    type: string
    default: "main"
  changelog_file:
    description: Location to output/update the CHANGELOG file.
    type: string
    default: "CHANGELOG.md"
  chglog_conf_dir:
    description: Location to output/update the CHANGELOG file.
    type: string
    default: ".chglog"
  chglog_config_file:
    type: string
    default: ".chglog/config.yml"
    description: Location of a git-chglog configuration file.
  circleci_api_host:
    type: string
    default: "https://circleci.com"
    description: Host URL of CircleCI API, i.e. https://circleci.com
  circleci_app_host:
    type: string
    default: "https://app.circleci.com"
    description: Host URL of CircleCI Web UI, i.e. https://app.circleci.com
  circle_token_var:
    description: Set the environment variable that has the CircleCI API token.
    type: env_var_name
    default: CIRCLE_TOKEN
  commit_file:
    description: Name of the file to set the commit hash to tag.
    type: string
    default: "commit-to-tag.txt"
  do_checkout:
    description: In case you need to customize.
    type: boolean
    default: true
  gh_token:
    description: Obsolete, use gh_token_var.
    type: env_var_name
    default: GH_TOKEN
  gh_token_var:
    description: Name of the environment variable holding the GitHub API token.
    type: env_var_name
    default: GH_TOKEN
  github_server:
    description: Github server domain.
    type: string
    default: "github.com"
  merge_type:
    description: Type of merge to perform, choose between merge|squash|rebase.
    type: enum
    enum: [ "merge", "rebase", "squash" ]
    default: "rebase"
  ssh_finger:
    description: Fingerprint of an SSH key that can be used to perform a merge into a branch.
    type: string
  trigger_tag_and_release:
    description: Trigger tag and release via script.
    type: boolean
    default: true
  working_directory:
    description: In case you need to customize.
    type: string
    default: "~/project"

executor: default
working_directory: "<< parameters.working_directory >>"
steps:
  - when:
      condition: << parameters.do_checkout >>
      steps:
        - checkout
  - add_ssh_keys:
      fingerprints:
        - << parameters.ssh_finger >>
  - add-missing-chglog-config:
      chglog_config_file: "<< parameters.chglog_config_file >>"
  - git-chglog-update:
      chglog_config_file: "<< parameters.chglog_config_file >>"
      changelog_file: "<< parameters.changelog_file >>"
  - run:
      environment:
        PARAM_CHANGELOG_FILE: "<< parameters.changelog_file >>"
        PARAM_BRANCH: "<< parameters.branch >>"
        PARAM_MERGE_TYPE: "<< parameters.merge_type >>"
        PARAM_COMMIT_FILE: "<< parameters.commit_file >>"
        PARAM_CONFIG_FILE: "<< parameters.chglog_config_file >>"
        PARAM_GH_SERVER: "<< parameters.github_server >>"
        PARAM_GH_TOKEN_VAR: "<< parameters.gh_token_var >>"
      name: Commit and merge the CHANGELOG updates
      command: << include(scripts/publish-changelog.sh) >>
  - persist_to_workspace:
      root: "."
      paths: [ "<< parameters.commit_file >>", "<< parameters.chglog_conf_dir >>" ]
  - when:
      condition: << parameters.trigger_tag_and_release >>
      steps:
        - trigger-tag-and-release:
            circle_token_var: "<< parameters.circle_token_var >>"
            circleci_api_host: "<< parameters.circleci_api_host >>"
            circleci_app_host: "<< parameters.circleci_app_host >>"
            gh_token_var: "<< parameters.gh_token_var >>"
