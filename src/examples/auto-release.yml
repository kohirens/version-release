description: >
  Pseudo example of how to push changes, auto update the changelog, merge, and
  publish a release to the main trunk branch.

  Go to
  https://github.com/kohirens/version-release-orb/blob/main/docs/setup-keys.md
  which provides details on how to setup the following:

    1. Make a PR for any CHANGELOG entries that will also need to be merged.
    2. Allow CircleCI to make a Github release on your behalf.
    3. Allow CircleCI to trigger workflows using the CircleCI API.

usage:
  version: 2.1

  orbs:
    vr: kohirens/version-release@latest

  parameters:
    circle_token_var:
      description: A CircleCI API token for trigger workflows.
      type: env_var_name
      default: CIRCLE_TOKEN
    gh_token_var:
      description: A GitHub write token to make API calls on yur behalf.
      type: env_var_name
      default: GH_TOKEN
    ssh_finger:
      description: Fingerprint of an SSH key to allow writing back to the repo.
      type: string
      default: "AB:CD:EF:GH:12:34:56:78"
    triggered_by_bot:
      description: Trigger publishing a release tag workflow.
      type: boolean
      default: false

  workflows:
    # Other workflows here
    # ...

    # Everything that should be done before a production release should precede this workflow.
    publish-changelog: # Run ONLY on main and when triggered_by_bot is true.
      when:
        and:
          - equal: [main, << pipeline.git.branch >>]
          - equal: [webhook, << pipeline.trigger_source >>]
      jobs:
        - vr/publish-changelog:
            context: orb-publishing
            ssh_finger: << pipeline.parameters.ssh_finger >>
            gh_token_var: << pipeline.parameters.gh_token_var >>
            circle_token_var: << pipeline.parameters.circle_token_var >>

    publish-release-tag: # This will be triggered by the publish-changelog workflow.
      when:
        and:
          - equal: [main, << pipeline.git.branch >>]
          - << pipeline.parameters.triggered_by_bot >>
          - matches:
              pattern: "^api|webhook$"
              value: << pipeline.trigger_source >>
      jobs:
        - vr/tag-and-release:
            context: orb-publishing
            gh_token_var: << pipeline.parameters.gh_token_var >>

    on-tag-release: # This will be triggered by the publish-release-tag workflow.
      jobs:
        - add-your-jobs-here:
            context: orb-publishing
            filters:
              tags:
                only: /^v?\d+\.\d+\.\d+$/
              branches:
                ignore: /.*/
