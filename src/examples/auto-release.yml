description: >
  Pseudo example of how to push changes, auto update the changelog, merge it,
  and publish a release tag for the main trunk branch.

  There are some prerequisites, so please go to
  https://github.com/kohirens/version-release-orb/blob/main/docs/how-to-release.md
  which provides details on how to setup the following:

    1. Make a PR for any CHANGELOG entries that will also need to be merged.
    2. Allow CircleCI to make a Github release on your behalf.
    3. Allow CircleCI to trigger workflows using the CircleCI API.

  Required Environment Variables:

    * CIRCLE_TOKEN
    * GH_TOKEN

usage:
  version: 2.1

  orbs:
    vr: kohirens/version-release@latest

  parameters:
    ctx_auto_release:
      default: "auto-release-vars"
      description: Release automation secrets CIRCLE_TOKEN and GH_TOKEN
      type: string
    ssh_finger:
      description: Fingerprint of an SSH key to allow writing back to the repo.
      type: string
      default: "ab:cd:ef:gh:12:34:56:78"
    triggered_flow:
      default: "workflow-selector"
      description: Workflow to be executed.
      type: string

  workflows:

    # Run on the trunk branch only and acts a controller as code is merged
    # to help decide which workflow executes.
    workflow-selector:
      when:
        and:
          - equal: ["workflow-selector", << pipeline.parameters.triggered_flow >>]
          - equal: [ main, << pipeline.git.branch >> ]
      jobs:
        - vr/workflow-selector:
            context: << pipeline.parameters.ctx_auto_release >>
            ssh_finger: << pipeline.parameters.ssh_finger >>

    publish-changelog:
      when:
        and:
          - equal: ["publish-changelog", << pipeline.parameters.triggered_flow >>]
      jobs:
        - vr/publish-changelog:
            context: << pipeline.parameters.ctx_auto_release >>
            ssh_finger: << pipeline.parameters.ssh_finger >>

    publish-release-tag:
      when:
        and:
          - equal: ["publish-release-tag", << pipeline.parameters.triggered_flow >>]
      jobs:
        - vr/tag-and-release:
            context: << pipeline.parameters.ctx_auto_release >>

    # Triggered by Circle after the publish-release-tag workflow completes.
    on-tag-release:
      jobs:
        - add-your-jobs-here:
            context: << pipeline.parameters.ctx_auto_release >>
            filters:
              tags:
                only: /^v?\d+\.\d+\.\d+$/
              branches:
                ignore: /.*/
