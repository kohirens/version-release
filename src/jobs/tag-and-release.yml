description: |2
  Trigger a job to tag and release a spcified branch.
parameters:
  attach_workspace:
    description: Set to `false` to skip attaching the workspace.
    type: boolean
    default: true
  attach_workspace_path:
    description: Set where to attach the workspace.
    type: string
    default: "."
  branch:
    description: Name of the branch to tag.
    type: string
    default: "main"
  changelogFile:
    description: Location to output/update the CHANGELOG file.
    type: string
    default: "CHANGELOG.md"
  configFile:
    description: Location of a git-chglog configuration file.
    type: string
    default: ".chglog/config.yml"
  commitFile:
    description: Name of the file holding the commit hash to tag.
    type: string
    default: "commit-to-tag.txt"
  do_checkout:
    description: Set to `false` to skip performing a checkout.
    type: boolean
    default: true
  ghToken:
    description: Name of the environment variable holding the GitHub API token.
    type: env_var_name
    default: GH_TOKEN
  taggedFile:
    description: File to store the semantic version that was used to tag the release.
    type: string
    default: "tagged.txt"
  working_directory:
    description: In case you need to customize.
    type: string
    default: "~/project"

executor: default
working_directory: "<< parameters.working_directory >>"
steps:
  - when:
      condition: << parameters.do_checkout >>
      steps:
        - checkout
  - when:
      condition: << parameters.attach_workspace >>
      steps:
        - attach_workspace:
            at: "<< parameters.attach_workspace_path >>"
  - git-chglog-update:
      configFile: "<< parameters.configFile >>"
      outputFile: "<< parameters.changelogFile >>"
  - run:
      environment:
        PARAM_BRANCH: "<< parameters.branch >>"
        PARAM_CHANGELOG_FILE: "<< parameters.changelogFile >>"
        PARAM_COMMIT_FILE: "<< parameters.commitFile >>"
        PARAM_TAG_FILE: "<< parameters.taggedFile >>"
      name: Make A New Release
      command: << include(scripts/tag-and-release.sh) >>
  - persist_to_workspace:
      root: '.'
      paths:
        - "<< parameters.taggedFile >>"
