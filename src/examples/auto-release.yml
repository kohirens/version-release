description: >
  Commit changes to the changelog and merge into a remote branch.
usage:
  version: 2.1

  orbs:
    vro: kohirens/version-release@latest

  parameters:
    ssh-finger:
      description: Fingerprint of an SSH key to allow writing back to the repo.
      type: string
      default: "AB:CD:EF:GH:12:34:56:78"
    triggered-by-bot:
      description: Trigger publishing a release tag workflow.
      type: boolean
      default: false

  workflows:
    # Other workflows here
    # ...

    # Everything that should be done before a production release should precede this workflow.
    publish-changelog: # Run ONLY on main and when triggered-by-bot is true.
      when:
        and:
          - equal: [main, << pipeline.git.branch >>]
          - << pipeline.parameters.triggered-by-bot >>
      jobs:
        - vro/publish-changelog:
            context: orb-publishing
            filters: { branches: { only: main } }
            sshFinger: << pipeline.parameters.ssh-finger >>

    publish-release-tag: # Run ONLY on main when kicked-off by publish-changelog workflow.
      when:
        and:
          - equal: [main, << pipeline.git.branch >>]
          - << pipeline.parameters.triggered-by-bot >>
          - matches:
              pattern: "^api|webhook$"
              value: << pipeline.trigger_source >>
      jobs:
        - vro/tag-and-release:
            context: orb-publishing
            filters: { branches: { only: main } }
            requires: [ vro/publish-changelog ]

    # Everything that should go to production should proceed this workflow.
    on-tag-release: # The filter will cause this to ONLY run on a release tags.
      jobs:
        - add-your-jobs-here:
            context: orb-publishing
            filters:
              tags:
                only: /^v?\d+\.\d+\.\d+$/
              branches:
                ignore: /.*/
